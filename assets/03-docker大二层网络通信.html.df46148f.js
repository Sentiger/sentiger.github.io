import{_ as n}from"./plugin-vue_export-helper.21dcd24c.js";import{o as s,c as e,e as a}from"./app.75979bb7.js";var i="/assets/big-second-net.288fcc9f.png";const l={},c=a('<p>\u5B9E\u9A8C\u76EE\u7684\uFF1A\u5728\u5BBF\u4E3B\u673A\u5185\u5BB9\u7684docker\u5BB9\u5668\u7684ip\u6BB5\u90FD\u662F\u7269\u7406\u4E3B\u673A\u7684ip\u6BB5\u3002\u8FD9\u6837\u5C31\u7C7B\u4F3C\u5BB9\u5668\u548C\u5BBF\u4E3B\u673A\u5728\u540C\u4E00\u4E2A\u7F51\u6BB5\u5185\uFF0C\u8FD9\u6837\u4E0D\u540C\u5BBF\u4E3B\u673A\u5185\u7684\u5BB9\u5668\u5C31\u53EF\u4EE5\u5728\u4E8C\u5C42\u7F51\u7EDC\u4E4B\u95F4\u901A\u4FE1\uFF0C\u8FD9\u91CC\u6D89\u53CA\u5230MAC\u5730\u5740\u6B3A\u9A97\u3002</p><p><img src="'+i+`" alt="\u5927\u4E8C\u5C42\u7F51\u7EDC" loading="lazy"></p><h2 id="web2\u521B\u5EFA\u5BB9\u5668ngx" tabindex="-1"><a class="header-anchor" href="#web2\u521B\u5EFA\u5BB9\u5668ngx" aria-hidden="true">#</a> web2\u521B\u5EFA\u5BB9\u5668ngx</h2><p>web2\u4E2D\u64CD\u4F5C\uFF0C\u521B\u5EFA\u5BB9\u5668\uFF0C\u4E14\u81EA\u5B9A\u4E49\u7F51\u7EDC\u3002</p><ul><li>\u5728web2\u4E2D\u542F\u52A8\u4E00\u4E2A\u7F51\u7EDC\u4E3A<code>none</code>\u7684\u5BB9\u5668<code>ngx</code></li><li>\u521B\u5EFA\u4E00\u5BF9<code>veth peer</code>\u5E76\u914D\u7F6Eip\uFF0C\u548C\u7ED1\u5B9A\u5230<code>ngx</code>\u5BB9\u5668\u5185</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> run --name ngx1 --rm --network none -d nginx:1.18-alpine
$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> veth1 <span class="token builtin class-name">type</span> veth peer name veth1-p
$ <span class="token function">mkdir</span> /var/run/netns
$ <span class="token function">docker</span> inspect ngx1 <span class="token operator">|</span><span class="token function">grep</span> Pid <span class="token comment"># \u67E5\u627E\u51FA\u5BB9\u5668\u8FDB\u7A0B</span>
$ <span class="token function">ln</span> -s /proc/869389/ns/net /var/run/netns/ngx1
$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth1 netns ngx1
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ngx1 <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> name eth0 dev veth1
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ngx1 <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">172.31</span>.0.10/24 dev eth0
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ngx1 <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev eth0 up
$ <span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it ngx1 <span class="token function">ifconfig</span>
<span class="token comment"># \u56E0\u4E3A\u8FD9\u91CC\u6CA1\u6709\u4F7F\u7528\u7F51\u6865\uFF0C\u76F4\u63A5veth1-p\u8FDE\u63A5\u5230\u5BBF\u4E3B\u673A\u7684\u5185\u6838\u534F\u8BAE\u6808\u3002\u6240\u4EE5\u914D\u7F6Eip\u5373\u53EF</span>
$ <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">172.31</span>.0.10/24 dev veth1-p
$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev veth1-p up
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="web2\u914D\u7F6Enetfilter-route" tabindex="-1"><a class="header-anchor" href="#web2\u914D\u7F6Enetfilter-route" aria-hidden="true">#</a> web2\u914D\u7F6Enetfilter/route</h2><p>\u6700\u7EC8web1\u8BBF\u95EEngx\u5BB9\u5668\uFF0C\u80AF\u5B9A\u662F\u8D70web1\u548Cweb2\u7684\u7269\u7406\u7F51\u7EDC\u901A\u4FE1\u3002web1\u8BBF\u95EEngx\u65F6\u5019\uFF0C\u76EE\u7684ip\u662Fngx\u7684\uFF0C\u4E0D\u662F\u672C\u4E3B\u673A\u5185\u7684\uFF0C\u6240\u4EE5\u8981\u8D70FORWARD\u3002</p><p>\u800C\u4E14\u8FD8\u8981\u914D\u7F6E\u8DEF\u7531\u76EE\u7684ip\u662F<code>172.31.0.10/24</code>\u7684\u8981\u8D70veth1-p\u63A5\u53E3\u3002\u8FD9\u4E2A\u9ED8\u8BA4\u521B\u5EFAveth\u5BF9\u7684\u65F6\u5019\u81EA\u52A8\u521B\u5EFA\uFF0C\u9700\u8981\u5220\u9664\u9ED8\u8BA4\u7684\u81EA\u5B9A\u4E49\u521B\u5EFA</p><p><strong>\u67E5\u770B/\u914D\u7F6E\u8DEF\u7531</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
$ route del -net <span class="token number">172.31</span>.0.0 netmask <span class="token number">255.255</span>.255.0 dev veth1-p
$ route <span class="token function">add</span> -host <span class="token number">172.31</span>.0.10 dev veth1-p

Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">172.31</span>.0.1      <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> eth0
<span class="token number">172.31</span>.0.0      <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> eth0
<span class="token number">172.31</span>.0.10     <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> veth1-p
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u914D\u7F6E\u6E90\u5730\u5740\u8F6C\u6362(SNAT)</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ iptables -t nat -A POSTROUTING -s <span class="token number">172.31</span>.0.3 -j  MASQUERADE

<span class="token comment"># \u5F00\u542FFORWARD\u529F\u80FD\uFF08\u9ED8\u8BA4\u662F\u5173\u95ED\u7684\uFF0C\u8FD9\u4E2A\u8981\u6CE8\u610F\uFF09</span>
$ <span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> /proc/sys/net/ipv4/ip_forward
$ iptables -t filter -P FORWARD ACCEPT 

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u7ED9\u5BB9\u5668ngx\u624B\u52A8\u6DFB\u52A0web1\u7684MAC\u5730\u5740</strong></p><ul><li>\u8FD9\u91CC\u56E0\u4E3A\u5BB9\u5668\u662F\u65E0\u6CD5\u901A\u8FC7arp\u83B7\u53D6web1\u7684MAC\u5730\u5740\uFF0C\u6240\u4EE5\u8FD9\u91CC\u624B\u52A8\u6DFB\u52A0\u4E0A\uFF0C\u505A\u5B9E\u9A8C\u3002</li><li>\u5F88\u591A\u7B2C\u4E09\u65B9\u8F6F\u4EF6\u4E5F\u662F\u5728\u521B\u5EFA\u5BB9\u5668\u7684\u65F6\u5019\uFF0C\u9ED8\u8BA4\u5C06\u8282\u70B9\u7684MAC\u5730\u5740\u6DFB\u52A0\u5230\u5BB9\u5668\u5185\u3002</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5C06web1\u7684MAC\u5730\u5740\u6DFB\u52A0\u5230ngx\u5BB9\u5668\u5185\uFF0C\u4E8C\u5C42\u901A\u4FE1\u90FD\u662FMAC\u5730\u5740\u3002</span>
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ngx1 arp -s <span class="token number">172.31</span>.0.3 <span class="token number">52</span>:54:99:e0:b1:2d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="web1\u914D\u7F6E\u8DEF\u7531\u4EE5\u53CAmac\u5730\u5740" tabindex="-1"><a class="header-anchor" href="#web1\u914D\u7F6E\u8DEF\u7531\u4EE5\u53CAmac\u5730\u5740" aria-hidden="true">#</a> web1\u914D\u7F6E\u8DEF\u7531\u4EE5\u53CAMAC\u5730\u5740</h2><p>web1\u8BBF\u95EEngx\u5BB9\u5668\uFF0C\u867D\u7136\u73B0\u5728\u5BF9\u4E8Eip\u662F\u540C\u4E00\u4E2A\u7F51\u6BB5\uFF0C\u4EA4\u6362\u673A\u4F1A\u8FDB\u884C\u5E7F\u64AD\uFF0C\u4F46\u662Fngx\u5728web2\u91CC\u662F\u53E6\u4E00\u4E2Anamespace\uFF0Cweb2\u662F\u4E0D\u4F1A\u8FDB\u884C\u4EE3\u7B54\u7684\u3002</p><p>\u6240\u4EE5\u8FD9\u91CC\u5C31\u8981\u6784\u9020\u4E2A\u5047\u7684\u3002\u5C06172.31.0.10\u7684MAC\u5730\u5740\u6362\u6210web2\u7684eth0\u6216\u8005web2\u4E2D\u7684veth1-p\u90FD\u662F\u53EF\u4EE5\uFF0C\u56E0\u4E3A\u4EA4\u6362\u673A\u90FD\u80FD\u627E\u5230\u8FD9\u4E24\u5757\u7F51\u5361\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u8FD9\u6837\u5C31\u76F4\u63A5\u80FD\u901A\u8FC7MAC\u901A\u4FE1\u4E86\u3002</span>
$ arp -s <span class="token number">192.168</span>.2.10 <span class="token number">52</span>:54:99:8f:67:73
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#\u6D4B\u8BD5" aria-hidden="true">#</a> \u6D4B\u8BD5</h2><p>web1\u8BBF\u95EEngx\u5BB9\u5668</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -i <span class="token number">172.31</span>.0.10

HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.18.0
Date: Wed, <span class="token number">15</span> Jun <span class="token number">2022</span> 05:39:40 GMT
Content-Type: text/html
Content-Length: <span class="token number">612</span>
Last-Modified: Thu, <span class="token number">29</span> Oct <span class="token number">2020</span> <span class="token number">15</span>:23:06 GMT
Connection: keep-alive
ETag: <span class="token string">&quot;5f9ade5a-264&quot;</span>
Accept-Ranges: bytes
<span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u603B\u7ED3" tabindex="-1"><a class="header-anchor" href="#\u603B\u7ED3" aria-hidden="true">#</a> \u603B\u7ED3</h2><p>\u5BB9\u5668\u6784\u9020\u5927\u4E8C\u5C42\u7F51\u7EDC\uFF0C\u8FD9\u91CC\u552F\u4E00\u8981\u89E3\u51B3\u7684\u5C31\u662F\u5BBF\u4E3B\u673A\u5185\u5BB9\u5668\u5185\u53D1\u7F51\u5361\u662F\u4E0D\u80FD\u88AB\u771F\u5B9E\u4EA4\u6362\u673A\u77E5\u9053\u7684\u3002\u6240\u4EE5\u5BBF\u4E3B\u673A\u662F\u4E0D\u77E5\u9053\u53E6\u4E00\u4E2A\u5BBF\u4E3B\u673A\u5185\u5BB9\u5668\u7684ip\uFF0C\u6240\u4EE5\u4E00\u822C\u90FD\u662F\u5728\u521B\u5EFA\u5BB9\u5668\u7684\u65F6\u5019\uFF0C\u9ED8\u8BA4\u6DFB\u52A0\u5230\u5BB9\u5668\u4E2DMAC\u5730\u5740</p><p>\u7B2C\u4E09\u65B9\u8F6F\u4EF6\u5C31\u662F\u8FD9\u6837\uFF0C\u6216\u8005\u4F7F\u7528\u8DEF\u7531\u5668\u4EE3\u7B54\u6A21\u5F0F</p>`,26),p=[c];function t(d,o){return s(),e("div",null,p)}var b=n(l,[["render",t],["__file","03-docker\u5927\u4E8C\u5C42\u7F51\u7EDC\u901A\u4FE1.html.vue"]]);export{b as default};
