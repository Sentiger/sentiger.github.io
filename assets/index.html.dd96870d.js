import{_ as o}from"./plugin-vue_export-helper.21dcd24c.js";import{r as i,o as r,c as l,a as n,b as a,d as e,e as t}from"./app.7bb5c305.js";const c={},d=n("h1",{id:"ingress-nginx",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ingress-nginx","aria-hidden":"true"},"#"),e(" ingress-nginx")],-1),u={href:"https://github.com/kubernetes/ingress-nginx",target:"_blank",rel:"noopener noreferrer"},p=e("ingress-nginx"),h=e(" Ingress controller for Kubernetes using NGINX as a reverse proxy and load balancer"),m=n("p",null,[e("To use, add the "),n("code",null,"kubernetes.io/ingress.class: nginx"),e(" annotation to your Ingress resources.")],-1),g=e("This chart bootstraps an ingress-nginx deployment on a "),b={href:"http://kubernetes.io",target:"_blank",rel:"noopener noreferrer"},v=e("Kubernetes"),_=e(" cluster using the "),k={href:"https://helm.sh",target:"_blank",rel:"noopener noreferrer"},f=e("Helm"),y=e(" package manager."),x=t(`<h2 id="prerequisites" tabindex="-1"><a class="header-anchor" href="#prerequisites" aria-hidden="true">#</a> Prerequisites</h2><ul><li>Kubernetes v1.16+</li></ul><h2 id="get-repo-info" tabindex="-1"><a class="header-anchor" href="#get-repo-info" aria-hidden="true">#</a> Get Repo Info</h2><div class="language-console ext-console line-numbers-mode"><pre class="language-console"><code>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="install-chart" tabindex="-1"><a class="header-anchor" href="#install-chart" aria-hidden="true">#</a> Install Chart</h2><p><strong>Important:</strong> only helm3 is supported</p><div class="language-console ext-console line-numbers-mode"><pre class="language-console"><code>helm install [RELEASE_NAME] ingress-nginx/ingress-nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>The command deploys ingress-nginx on the Kubernetes cluster in the default configuration.</p><p><em>See <a href="#configuration">configuration</a> below.</em></p>`,9),w=e("See "),X={href:"https://helm.sh/docs/helm/helm_install/",target:"_blank",rel:"noopener noreferrer"},I=e("helm install"),E=e(" for command documentation."),q=t(`<h2 id="uninstall-chart" tabindex="-1"><a class="header-anchor" href="#uninstall-chart" aria-hidden="true">#</a> Uninstall Chart</h2><div class="language-console ext-console line-numbers-mode"><pre class="language-console"><code>helm uninstall [RELEASE_NAME]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>This removes all the Kubernetes components associated with the chart and deletes the release.</p>`,3),A=e("See "),L={href:"https://helm.sh/docs/helm/helm_uninstall/",target:"_blank",rel:"noopener noreferrer"},C=e("helm uninstall"),N=e(" for command documentation."),S=t(`<h2 id="upgrading-chart" tabindex="-1"><a class="header-anchor" href="#upgrading-chart" aria-hidden="true">#</a> Upgrading Chart</h2><div class="language-console ext-console line-numbers-mode"><pre class="language-console"><code>helm upgrade [RELEASE_NAME] [CHART] --install
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,2),P=e("See "),B={href:"https://helm.sh/docs/helm/helm_upgrade/",target:"_blank",rel:"noopener noreferrer"},T=e("helm upgrade"),z=e(" for command documentation."),D=n("h3",{id:"upgrading-with-zero-downtime-in-production",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#upgrading-with-zero-downtime-in-production","aria-hidden":"true"},"#"),e(" Upgrading With Zero Downtime in Production")],-1),M=e("By default the ingress-nginx controller has service interruptions whenever it's pods are restarted or redeployed. In order to fix that, see the excellent blog post by Lindsay Landry from Codecademy: "),R={href:"https://medium.com/codecademy-engineering/kubernetes-nginx-and-zero-downtime-in-production-2c910c6a5ed8",target:"_blank",rel:"noopener noreferrer"},U=e("Kubernetes: Nginx and Zero Downtime in Production"),W=e("."),K=t('<h3 id="migrating-from-stable-nginx-ingress" tabindex="-1"><a class="header-anchor" href="#migrating-from-stable-nginx-ingress" aria-hidden="true">#</a> Migrating from stable/nginx-ingress</h3><p>There are two main ways to migrate a release from <code>stable/nginx-ingress</code> to <code>ingress-nginx/ingress-nginx</code> chart:</p><ol><li>For Nginx Ingress controllers used for non-critical services, the easiest method is to <a href="#uninstall-chart">uninstall</a> the old release and <a href="#install-chart">install</a> the new one</li><li>For critical services in production that require zero-downtime, you will want to: <ol><li><a href="#install-chart">Install</a> a second Ingress controller</li><li>Redirect your DNS traffic from the old controller to the new controller</li><li>Log traffic from both controllers during this changeover</li><li><a href="#uninstall-chart">Uninstall</a> the old controller once traffic has fully drained from it</li><li>For details on all of these steps see <a href="#upgrading-with-zero-downtime-in-production">Upgrading With Zero Downtime in Production</a></li></ol></li></ol>',3),F=e('Note that there are some different and upgraded configurations between the two charts, described by Rimas Mocevicius from JFrog in the "Upgrading to ingress-nginx Helm chart" section of '),G={href:"https://rimusz.net/migrating-to-ingress-nginx",target:"_blank",rel:"noopener noreferrer"},H=e("Migrating from Helm chart nginx-ingress to ingress-nginx"),V=e(". As the "),j=n("code",null,"ingress-nginx/ingress-nginx",-1),O=e(" chart continues to update, you will want to check current differences by running "),Y=n("a",{href:"#configuration"},"helm configuration",-1),Z=e(" commands on both charts."),J=n("h2",{id:"configuration",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#configuration","aria-hidden":"true"},"#"),e(" Configuration")],-1),Q=e("See "),$={href:"https://helm.sh/docs/intro/using_helm/#customizing-the-chart-before-installing",target:"_blank",rel:"noopener noreferrer"},ee=e("Customizing the Chart Before Installing"),ne=e(". To see all configurable options with detailed comments, visit the chart's "),se=n("a",{href:"./values.yaml"},"values.yaml",-1),ae=e(", or run these configuration commands:"),te=t(`<div class="language-console ext-console line-numbers-mode"><pre class="language-console"><code>helm show values ingress-nginx/ingress-nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="poddisruptionbudget" tabindex="-1"><a class="header-anchor" href="#poddisruptionbudget" aria-hidden="true">#</a> PodDisruptionBudget</h3>`,2),oe=e("Note that the PodDisruptionBudget resource will only be defined if the replicaCount is greater than one, else it would make it impossible to evacuate a node. See "),ie={href:"https://github.com/helm/charts/issues/7127",target:"_blank",rel:"noopener noreferrer"},re=e("gh issue #7127"),le=e(" for more info."),ce=t('<h3 id="prometheus-metrics" tabindex="-1"><a class="header-anchor" href="#prometheus-metrics" aria-hidden="true">#</a> Prometheus Metrics</h3><p>The Nginx ingress controller can export Prometheus metrics, by setting <code>controller.metrics.enabled</code> to <code>true</code>.</p><p>You can add Prometheus annotations to the metrics service using <code>controller.metrics.service.annotations</code>. Alternatively, if you use the Prometheus Operator, you can enable ServiceMonitor creation using <code>controller.metrics.serviceMonitor.enabled</code>.</p><h3 id="ingress-nginx-nginx-status-page-stats-server" tabindex="-1"><a class="header-anchor" href="#ingress-nginx-nginx-status-page-stats-server" aria-hidden="true">#</a> ingress-nginx nginx_status page/stats server</h3><p>Previous versions of this chart had a <code>controller.stats.*</code> configuration block, which is now obsolete due to the following changes in nginx ingress controller:</p>',5),de=e("In "),ue={href:"https://github.com/kubernetes/ingress-nginx/blob/main/Changelog.md#0161",target:"_blank",rel:"noopener noreferrer"},pe=e("0.16.1"),he=e(", the vts (virtual host traffic status) dashboard was removed"),me=e("In "),ge={href:"https://github.com/kubernetes/ingress-nginx/blob/main/Changelog.md#0230",target:"_blank",rel:"noopener noreferrer"},be=e("0.23.0"),ve=e(", the status page at port 18080 is now a unix socket webserver only available at localhost. You can use "),_e=n("code",null,"curl --unix-socket /tmp/nginx-status-server.sock http://localhost/nginx_status",-1),ke=e(" inside the controller container to access it locally, or use the snippet from "),fe={href:"https://github.com/kubernetes/ingress-nginx/blob/main/Changelog.md#0230",target:"_blank",rel:"noopener noreferrer"},ye=e("nginx-ingress changelog"),xe=e(" to re-enable the http server"),we=n("h3",{id:"externaldns-service-configuration",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#externaldns-service-configuration","aria-hidden":"true"},"#"),e(" ExternalDNS Service Configuration")],-1),Xe=e("Add an "),Ie={href:"https://github.com/kubernetes-incubator/external-dns",target:"_blank",rel:"noopener noreferrer"},Ee=e("ExternalDNS"),qe=e(" annotation to the LoadBalancer service:"),Ae=t(`<div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">controller</span><span class="token punctuation">:</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">external-dns.alpha.kubernetes.io/hostname</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>example.com.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="aws-l7-elb-with-ssl-termination" tabindex="-1"><a class="header-anchor" href="#aws-l7-elb-with-ssl-termination" aria-hidden="true">#</a> AWS L7 ELB with SSL Termination</h3>`,2),Le=e("Annotate the controller as shown in the "),Ce={href:"https://github.com/kubernetes/ingress-nginx/blob/main/deploy/aws/l7/service-l7.yaml",target:"_blank",rel:"noopener noreferrer"},Ne=e("nginx-ingress l7 patch"),Se=e(":"),Pe=t(`<div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">controller</span><span class="token punctuation">:</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">targetPorts</span><span class="token punctuation">:</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span> http
      <span class="token key atrule">https</span><span class="token punctuation">:</span> http
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-ssl-cert</span><span class="token punctuation">:</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>acm<span class="token punctuation">:</span>XX<span class="token punctuation">-</span>XXXX<span class="token punctuation">-</span>X<span class="token punctuation">:</span>XXXXXXXXX<span class="token punctuation">:</span>certificate/XXXXXXXX<span class="token punctuation">-</span>XXXX<span class="token punctuation">-</span>XXXX<span class="token punctuation">-</span>XXXX<span class="token punctuation">-</span>XXXXXXXXXX
      <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</span><span class="token punctuation">:</span> <span class="token string">&quot;http&quot;</span>
      <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-ssl-ports</span><span class="token punctuation">:</span> <span class="token string">&quot;https&quot;</span>
      <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-connection-idle-timeout</span><span class="token punctuation">:</span> <span class="token string">&#39;3600&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="aws-route53-mapper" tabindex="-1"><a class="header-anchor" href="#aws-route53-mapper" aria-hidden="true">#</a> AWS route53-mapper</h3>`,2),Be=e("To configure the LoadBalancer service with the "),Te={href:"https://github.com/kubernetes/kops/tree/master/addons/route53-mapper",target:"_blank",rel:"noopener noreferrer"},ze=e("route53-mapper addon"),De=e(", add the "),Me=n("code",null,"domainName",-1),Re=e(" annotation and "),Ue=n("code",null,"dns",-1),We=e(" label:"),Ke=t(`<div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">controller</span><span class="token punctuation">:</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">dns</span><span class="token punctuation">:</span> <span class="token string">&quot;route53&quot;</span>
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">domainName</span><span class="token punctuation">:</span> <span class="token string">&quot;kubernetes-example.com&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="additional-internal-load-balancer" tabindex="-1"><a class="header-anchor" href="#additional-internal-load-balancer" aria-hidden="true">#</a> Additional Internal Load Balancer</h3><p>This setup is useful when you need both external and internal load balancers but don&#39;t want to have multiple ingress controllers and multiple ingress objects per application.</p><p>By default, the ingress object will point to the external load balancer address, but if correctly configured, you can make use of the internal one if the URL you are looking up resolves to the internal load balancer&#39;s URL.</p><p>You&#39;ll need to set both the following values:</p><p><code>controller.service.internal.enabled</code><code>controller.service.internal.annotations</code></p><p>If one of them is missing the internal load balancer will not be deployed. Example you may have <code>controller.service.internal.enabled=true</code> but no annotations set, in this case no action will be taken.</p><p><code>controller.service.internal.annotations</code> varies with the cloud service you&#39;re using.</p><p>Example for AWS:</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">controller</span><span class="token punctuation">:</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">internal</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token comment"># Create internal ELB</span>
        <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-internal</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
        <span class="token comment"># Any other annotation can be declared here.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Example for GCE:</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">controller</span><span class="token punctuation">:</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">internal</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token comment"># Create internal LB. More informations: https://cloud.google.com/kubernetes-engine/docs/how-to/internal-load-balancing</span>
        <span class="token comment"># For GKE versions 1.17 and later</span>
        <span class="token key atrule">networking.gke.io/load-balancer-type</span><span class="token punctuation">:</span> <span class="token string">&quot;Internal&quot;</span>
        <span class="token comment"># For earlier versions</span>
        <span class="token comment"># cloud.google.com/load-balancer-type: &quot;Internal&quot;</span>
        
        <span class="token comment"># Any other annotation can be declared here. </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Example for Azure:</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">controller</span><span class="token punctuation">:</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token comment"># Create internal LB</span>
        <span class="token key atrule">service.beta.kubernetes.io/azure-load-balancer-internal</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
        <span class="token comment"># Any other annotation can be declared here.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Example for Oracle Cloud Infrastructure:</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">controller</span><span class="token punctuation">:</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token comment"># Create internal LB</span>
        <span class="token key atrule">service.beta.kubernetes.io/oci-load-balancer-internal</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
        <span class="token comment"># Any other annotation can be declared here.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>An use case for this scenario is having a split-view DNS setup where the public zone CNAME records point to the external balancer URL while the private zone CNAME records point to the internal balancer URL. This way, you only need one ingress kubernetes object.</p><p>Optionally you can set <code>controller.service.loadBalancerIP</code> if you need a static IP for the resulting <code>LoadBalancer</code>.</p><h3 id="ingress-admission-webhooks" tabindex="-1"><a class="header-anchor" href="#ingress-admission-webhooks" aria-hidden="true">#</a> Ingress Admission Webhooks</h3><p>With nginx-ingress-controller version 0.25+, the nginx ingress controller pod exposes an endpoint that will integrate with the <code>validatingwebhookconfiguration</code> Kubernetes feature to prevent bad ingress from being added to the cluster. <strong>This feature is enabled by default since 0.31.0.</strong></p>`,20),Fe=e("With nginx-ingress-controller in 0.25.* work only with kubernetes 1.14+, 0.26 fix "),Ge={href:"https://github.com/kubernetes/ingress-nginx/pull/4521",target:"_blank",rel:"noopener noreferrer"},He=e("this issue"),Ve=t(`<h3 id="helm-error-when-upgrading-spec-clusterip-invalid-value" tabindex="-1"><a class="header-anchor" href="#helm-error-when-upgrading-spec-clusterip-invalid-value" aria-hidden="true">#</a> Helm Error When Upgrading: spec.clusterIP: Invalid value: &quot;&quot;</h3><p>If you are upgrading this chart from a version between 0.31.0 and 1.2.2 then you may get an error like this:</p><div class="language-console ext-console line-numbers-mode"><pre class="language-console"><code>Error: UPGRADE FAILED: Service &quot;?????-controller&quot; is invalid: spec.clusterIP: Invalid value: &quot;&quot;: field is immutable
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,3),je=e("Detail of how and why are in "),Oe={href:"https://github.com/helm/charts/pull/13646",target:"_blank",rel:"noopener noreferrer"},Ye=e("this issue"),Ze=e(" but to resolve this you can set "),Je=n("code",null,"xxxx.service.omitClusterIP",-1),Qe=e(" to "),$e=n("code",null,"true",-1),en=e(" where "),nn=n("code",null,"xxxx",-1),sn=e(" is the service referenced in the error."),an=n("p",null,[e("As of version "),n("code",null,"1.26.0"),e(" of this chart, by simply not providing any clusterIP value, "),n("code",null,'invalid: spec.clusterIP: Invalid value: "": field is immutable'),e(" will no longer occur since "),n("code",null,'clusterIP: ""'),e(" will not be rendered.")],-1);function tn(on,rn){const s=i("ExternalLinkIcon");return r(),l("div",null,[d,n("p",null,[n("a",u,[p,a(s)]),h]),m,n("p",null,[g,n("a",b,[v,a(s)]),_,n("a",k,[f,a(s)]),y]),x,n("p",null,[n("em",null,[w,n("a",X,[I,a(s)]),E])]),q,n("p",null,[n("em",null,[A,n("a",L,[C,a(s)]),N])]),S,n("p",null,[n("em",null,[P,n("a",B,[T,a(s)]),z])]),D,n("p",null,[M,n("a",R,[U,a(s)]),W]),K,n("p",null,[F,n("a",G,[H,a(s)]),V,j,O,Y,Z]),J,n("p",null,[Q,n("a",$,[ee,a(s)]),ne,se,ae]),te,n("p",null,[oe,n("a",ie,[re,a(s)]),le]),ce,n("ul",null,[n("li",null,[de,n("a",ue,[pe,a(s)]),he]),n("li",null,[me,n("a",ge,[be,a(s)]),ve,_e,ke,n("a",fe,[ye,a(s)]),xe])]),we,n("p",null,[Xe,n("a",Ie,[Ee,a(s)]),qe]),Ae,n("p",null,[Le,n("a",Ce,[Ne,a(s)]),Se]),Pe,n("p",null,[Be,n("a",Te,[ze,a(s)]),De,Me,Re,Ue,We]),Ke,n("p",null,[Fe,n("a",Ge,[He,a(s)])]),Ve,n("p",null,[je,n("a",Oe,[Ye,a(s)]),Ze,Je,Qe,$e,en,nn,sn]),an])}var dn=o(c,[["render",tn],["__file","index.html.vue"]]);export{dn as default};
