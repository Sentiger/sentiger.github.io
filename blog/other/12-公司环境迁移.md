---
title: 记录一次公司环境迁移
order: 12
category:
---

由于历史原因，之前公司项目众多，线上环境也是比较复杂，比较乱，而最近业务下降，为了减轻公司相关云平台费用以及全部整理下线上环境。

由于公司项目大部分都是基于PHP开发的，当初也是直接在服务器上安装PHP环境的，最大的一个问题是线上安装了各种的PHP扩展，以及各个服务器中的配置，运行环境不统一，维护起来非常复杂，所以这次直接进行一次环境迁移。

本来计划使用k8s，但是由于公司其他人员对这块不熟悉，以及没有专业的k8s运维，进而降级，使用了快要淘汰的docker进行环境搭建，不过应对与我们公司项目还是比较合适的。

在这迁移的过程中遇到了比较多的问题，这里大致记录下。

## 相关问题

**1. iconv问题**

由于历史代码，项目中有使用iconv函数，发现使用`7.2.21-fpm-alpine3.10`镜像有bug，发现是apline的一个镜像的问题。

```yaml
# DockerFile中需要安装以下库
RUN apk add --no-cache --allow-untrusted gnu-libiconv
ENV LD_PRELOAD /usr/lib/preloadable_libiconv.so php
```

**2. 性能问题**

当环境构建完成之后，然后将线上流量迁移到新环境中，发现服务器的CPU飙升，找了一系列问题，包括最后使用源码安装之后，都没找到对应的问题。最终只有对比历史环境和新环境的配置。最终发现php的opcache扩展没有开启。

最终开启之后CPU立马将下来，而且比较稳定。发现这个还是很有作用的。


**3. alpine镜像pdo问题**

使用laravel框架的，环境是`7.2.21-fpm-alpine3.10`发现一个问题，对于浮点数查询出来会出现精度丢失问题。也是找了各种的解决方案。

```
1. 最开始是直接修改laravel的数据库配置 PDO::ATTR_EMULATE_PREPARES。但是造成了一个问题，就是所有的浮点数，整数默认都是返回的字符串，而对于前端使用===来处理很多数据导致有问题，所以立马修改回去。

2. 通过官方查找php在alpine编译的时候出现了这个问题，在 7.4.20-fpm-alpine3.10 以上的版本解决了这个问题。但是由于我们历史使用的是7.2版本，所以不轻易升级，要不然很多问题都没经过测试。以下是相关的issue
https://github.com/yeszao/dnmp/issues/272
https://gitlab.alpinelinux.org/alpine/aports/-/issues/11072#login-panephp

3. 最终是舍弃了我比较倾向的alpine环境，因为这个体积小。选择了debian的基础镜像php  7.2.21-fpm

```

**4. 定时任务**

在使用`7.2.21-fpm`这个镜像中的定时任务发现，就是定时任务不执行，最终尝试了好多得到了解决

由于是通过挂载crontab任务的，`${PHP7_2_21_CONFIG_DIR}crontabs:/var/spool/cron/crontabs` 然后这里的定时任务是通过在phpstorm中编辑完成，然后上传的发现怎么也不运行。

尝试解决文件权限问题，用户组问题，最终都发现不是这个问题。但是通过进入容器进行编辑就发现定时任务能运行。最终发现只能通过命令或者vim来编辑问题，没有具体去找这个问题，发现就是文件格式应该不对，没有读取成功。所以每次更新记得在服务器上进行更新
